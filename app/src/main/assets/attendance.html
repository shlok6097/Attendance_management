<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Sheet</title>
    <style>
        body { font-family: Arial; margin: 0; padding: 10px; background: #f4f4f9; }
        .table-container { width: 100%; height: 90vh; overflow: auto; border: 1px solid #ccc; background: white; }
        table { border-collapse: collapse; width: max-content; min-width: 100%; }
        th, td { border: 1px solid #ddd; text-align: center; padding: 8px 12px; white-space: nowrap; }
        th { background: #3f51b5; color: white; position: sticky; top: 0; z-index: 2; }
        .present { background-color: #b2ff59; }
        .absent { background-color: #ff8a80; }
        td { cursor: pointer; }
    </style>
</head>
<body>
<div class="table-container">
    <table id="attendanceTable">
        <thead>
        <tr id="headerRow">
            <th>Sl No</th>
            <th>USN</th>
            <th>Name</th>
            <th>%</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let __sessions = [];
    let __studentsById = {};      // studentId -> { student, tr }
    let __sessionColIndex = {};    // sessionId -> column index in table

   function loadAttendance(students, sessions) {
    const headerRow = document.getElementById("headerRow");
    const body = document.getElementById("tableBody");

    while (headerRow.children.length > 4) headerRow.removeChild(headerRow.children[headerRow.children.length - 2]);
    body.innerHTML = "";

    __sessions = sessions.slice();
    __sessionColIndex = {};
    sessions.forEach((session, i) => {
        const th = document.createElement("th");
        th.textContent = session.date;
        headerRow.insertBefore(th, headerRow.lastElementChild);
        __sessionColIndex[session.id] = 3 + i; // 3 fixed columns
    });

    __studentsById = {};
    const fragment = document.createDocumentFragment();

    students.forEach((student, rowIndex) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${rowIndex + 1}</td><td>${student.usn}</td><td>${student.name}</td>`;

        // Build attendance map keyed by sessionId
        const attendanceBySessionId = {};
        student.attendance.forEach(a => {
            attendanceBySessionId[a.sessionId] = a.status;
        });

        let attendedCount = 0;
        __sessions.forEach(session => {
            const status = attendanceBySessionId[session.id] || "A";
            if (status === "P") attendedCount++;

            const td = document.createElement("td");
            td.id = `status-${student.id}-${session.id}`;
            td.textContent = status;
            td.className = status === "P" ? "present" : "absent";

            td.addEventListener("click", () => toggleStatus(student.id, session.id));

            tr.appendChild(td);
        });

        const tdPercent = document.createElement("td");
        tdPercent.textContent = Math.round(attendedCount / __sessions.length * 100) + "%";
        tr.appendChild(tdPercent);

        __studentsById[student.id] = { student, tr, attendanceBySessionId };
        fragment.appendChild(tr);
    });

    body.appendChild(fragment);
}


    // Toggle attendance on click
    function toggleStatus(studentId, sessionId) {
        const mapping = __studentsById[studentId];
        if (!mapping) return;

        const { student, tr } = mapping;
        const colIndex = __sessionColIndex[sessionId];
        if (colIndex === undefined) return;

        const td = tr.children[colIndex];
        const newStatus = td.textContent === "P" ? "A" : "P";
        td.textContent = newStatus;
        td.className = newStatus === "P" ? "present" : "absent";

        // Update model
        const sessionDate = __sessions.find(s => s.id === sessionId).date;
        student.attendance[sessionDate] = newStatus;

        // Recalculate %
        let attendedCount = 0;
        __sessions.forEach(s => { if ((student.attendance[s.date] || "A") === "P") attendedCount++; });
        tr.lastElementChild.textContent = Math.round(attendedCount / __sessions.length * 100) + "%";

        // Notify Android
        if (typeof Android !== "undefined" && Android.updateAttendance) {
            Android.updateAttendance(student.id, sessionId, newStatus);
        }
    }

    // Update a single cell from Android after DB change
    function updateFromAndroid(studentId, sessionId, status) {
        const mapping = __studentsById[studentId];
        if (!mapping) return;

        const { student, tr } = mapping;
        const colIndex = __sessionColIndex[sessionId];
        if (colIndex === undefined) return;

        const td = tr.children[colIndex];
        td.textContent = status;
        td.className = status === "P" ? "present" : "absent";

        const sessionDate = __sessions.find(s => s.id === sessionId).date;
        student.attendance[sessionDate] = status;

        // Recalculate %
        let attendedCount = 0;
        __sessions.forEach(s => { if ((student.attendance[s.date] || "A") === "P") attendedCount++; });
        tr.lastElementChild.textContent = Math.round(attendedCount / __sessions.length * 100) + "%";
    }
</script>
</body>
</html>
